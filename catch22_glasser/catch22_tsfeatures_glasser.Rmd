---
title: "Alpraz Catch22: Glasser360"
author: "Valerie Jill Sydnor"
output:
  html_document:
    code_folding: show
    highlight: haddock
    theme: lumen
    toc: yes
    toc_depth: 3
    toc_float: yes
---
```{r setup, include=FALSE}
library(ciftiTools)
ciftiTools.setOption('wb_path', '/Users/valeriesydnor/Software/workbench/')
library(cifti) #is.cifti, read_cifti, readcii masked from ciftiTools
library(catch22)
library(ggseg)
library(ggsegExtra)
library(ggsegGlasser)
library(viridis)
library(dplyr)
library(matrixTests)
```

```{r}
glasser.parcel.labels <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/glasser360_regionlist.csv", header = T)
```

```{r}
participants <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/sub_ses_passQC_finallist.csv", header = FALSE)
```

```{r}
drugcode <- read.csv("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/sub_ses_drugvplacebo.csv", header = TRUE)
```

## Study-Specific Cortical Mask

**Create a parcellated study-specific group mask based on the fslr vertex-level group mask**

The vertex-level group mask was generated by 1. identifying vertices where the timeseries (210 TRs) sum of squares was > 50 at the individual participant level, and then 2. identifying vertices where all participant sessions had good data

Below we parcellate the vertex-level group mask with the Glasser 360 fslr dlabel.nii file, and retain parcels where >= 50% of vertices were including in the vertex-level group mask (i.e., retain parcels  where at least 50% of vertices had data from all subjects)

```{r, echo=TRUE, eval=FALSE}
#parcellate the vertex-level group mask with Glasser360 HCP multimodal atlas
ciftiTools::run_wb_cmd("-cifti-parcellate /cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/study_cortexmask_vertex.dscalar.nii /cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/glasser_space-fsLR_den-32k_desc-atlas.dlabel.nii COLUMN /cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/study_cortexmask_glasser360_unthresholded.pscalar.nii", intern = FALSE, ignore.stdout = NULL, ignore.stderr = NULL)
```

```{r, warning=F}
#read in the parcellated group mask
cifti.mask.unthresholded <- read_cifti("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/study_cortexmask_glasser360_unthresholded.pscalar.nii")

#information about the unthresholded mask
  #191 parcels have 100% of vertices included in the group mask
  #3 parcels have 50-60% of vertices included
  #6 parcels have 60-70% of vertices included
  #5 parcels have 70-80% of vertices included
  #9 parcels have 80-90% of vertices included
  #18 parcelts have 90-99% of vertices included

#threshold the parcellated mask to retain only parcels with >= 50% of vertices have data for all subjects (final parcel number = 232)
glasser360.parcelmask.unthresholded <- cifti.mask.unthresholded$data
glasser360.parcelmask.thresholded <- ifelse(glasser360.parcelmask.unthresholded < 0.5, 0, glasser360.parcelmask.unthresholded)
glasser360.parcelmask.thresholded <- ifelse(glasser360.parcelmask.thresholded >= 0.5, 1, glasser360.parcelmask.thresholded)
```

```{r, echo=TRUE, eval=FALSE}
#save mask as vector
write.csv(x = glasser360.parcelmask.thresholded, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/study_cortexmask_glasser360_thresholded.txt", row.names = F, quote = F)
```

```{r echo=TRUE, message=FALSE, warning=FALSE, comment=FALSE}
#visualize the parcellated and thresholded group mask
finalmask <- as.data.frame(glasser360.parcelmask.thresholded)
finalmask$label <- glasser.parcel.labels$label
ggseg(.data = finalmask, atlas = "glasser", mapping=aes(fill=glasser360.parcelmask.thresholded), position = c("stacked")) + theme_void() + scale_fill_gradient2(low= "black", high = "dodgerblue3", guide = "colourbar", aesthetics = "fill", name = NULL, midpoint = 0.5) + theme(legend.position = "none")
rm(finalmask)
```

## Catch22 Timeseries Analysis

**Run catch22 on each cortical parcel**

Catch22 (https://link.springer.com/article/10.1007/s10618-019-00647-x) calculates 22 timeseries-derived features previously shown to have high discrimination accuracy across 93 distinct classification tasks

```{r}
knitr::include_graphics("/Users/valeriesydnor/Desktop/catch22_feature_descriptions.png")
```

```{r, warning=F}
alpraz_glasser_catch22 <- function(subid, sesid){
  
  #read in the parcellated time series into a matrix
  ts.path <- sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/xcpabcd/task_regress/surface/xcp_abcd/%1$s/%2$s/func/%1$s_%2$s_task-emotionid_space-fsLR_atlas-Glasser_den-91k_den-91k_bold.ptseries.nii", subid, sesid)
  ts <- read_cifti(ts.path)
  ts.matrix <- ts$data
 
  #mask the parcellated time series with the group mask
  ts.matrix.masked <- sweep(ts.matrix, MARGIN = 1, glasser360.parcelmask.thresholded, `*`) 
  
  #apply catch22 to each parcel to generate 22 parcel-specific timeseries measures
  catchmatrix <- matrix(data = NA, nrow = 360, ncol = 22) #empty matrix to fill 
  for(row in c(1:360)){
    if(sum(ts.matrix.masked[row,]) == 0){ #if the parcel is masked out
      catch.vector <- data.matrix(t((replicate(22, NA)))) #assign NA to catch22 output
      catchmatrix[row,] <- catch.vector} #and save in matrix
    else { #if the parcel is included
      catch.vector <- (data.matrix(t(catch22_all(ts.matrix.masked[row,])))) #run catch22
      catchmatrix[row,] <- catch.vector[2,]} #and save in matrix
  }
  class(catchmatrix) <- "numeric"

  #save the catch22 output to a csv
  dir.create(path = sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/%1$s/%2$s/", subid, sesid), recursive = TRUE)
  write.table(x = catchmatrix, file = sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/%1$s/%2$s/%1$s_%2$s_glasser360_catch22.csv", subid, sesid), quote = F, row.names = F, col.names = F)
  
  return(catchmatrix)
  
rm(ts)
rm(ts.matrix)
rm(ts.matrix.masked)
rm(catchmatrix)
}
```

```{r, warning = F}
for(row in c(1:nrow(participants))){
  subid=participants[row,1]
  sesid=participants[row,2]
  #if(!(file.exists(sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360//%1$s/%2$s/%1$s_%2$s_glasser360_catch22.csv", subid, sesid))))
  assign(sprintf("%1$s.%2$s.catch22.matrix", subid, sesid), alpraz_glasser_catch22(subid, sesid))
}
```

**Save a sub_ses X parcel feature matrix for each of the catch22 features**

```{r}
for(feature in c(1:22)){
  assign(sprintf("catch%s_sesxparcel_matrix", feature), as.data.frame(matrix(NA, ncol=364, nrow=nrow(participants))))
}
```

```{r}
regionheaders <- glasser.parcel.labels$orig_parcelname
demoheaders <- c("subid","sesid","drug","meanFD")
colheaders <- as.matrix(c(demoheaders,regionheaders))

for(row in c(1:nrow(participants))){
  subid=participants[row,1]
  sesid=participants[row,2]
  drug=participants[row,3]
  meanFD=participants[row,4]
  dataname <- sprintf("%1$s.%2$s.catch22.matrix", subid, sesid)
  catch1_sesxparcel_matrix[row,] <-  cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,1]))
  colnames(catch1_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch1_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch2_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,2]))
  colnames(catch2_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch2_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch3_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,3]))
  colnames(catch3_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch3_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch4_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,4]))
  colnames(catch4_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch4_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch5_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,5]))
  colnames(catch5_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch5_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch6_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,6]))
  colnames(catch6_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch6_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch7_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,7]))
  colnames(catch7_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch7_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch8_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,8]))
  colnames(catch8_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch8_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch9_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,9]))
  colnames(catch9_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch9_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch10_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,10]))
  colnames(catch10_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch10_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch11_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,11]))
  colnames(catch11_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch11_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch12_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,12]))
  colnames(catch12_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch12_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch13_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,13]))
  colnames(catch13_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch13_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch14_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,14]))
  colnames(catch14_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch14_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch15_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,15]))
  colnames(catch15_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch15_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch16_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,16]))
  colnames(catch16_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch16_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch17_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,17]))
  colnames(catch17_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch17_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch18_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,18]))
  colnames(catch18_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch18_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch19_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,19]))
  colnames(catch19_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch19_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch20_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,20]))
  colnames(catch20_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch20_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch21_sesxparcel_matrix[row,] <- cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,21]))
  colnames(catch21_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch21_sesxparcel_matrix.csv", row.names = F, quote = F)
  catch22_sesxparcel_matrix[row,] <-cbind(subid,sesid,drug,meanFD,t(eval(as.name(dataname))[,22]))
  colnames(catch22_sesxparcel_matrix) <- colheaders
  write.csv(catch1_sesxparcel_matrix, file = "/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/catch22_sesxparcel_matrix.csv", row.names = F, quote = F)
}
```

## Catch22 Average Cortical Maps

**Calculate and visualize the average cortical map for each of the 22 features**

```{r}
alpraz_glasser_averagemap <- function(feature){
  
  dataname <- sprintf("catch%s_sesxparcel_matrix", feature)
  parceldata <- eval(as.name(dataname))
  parceldata <- parceldata %>% dplyr::select(-subid, -sesid, -drug, -meanFD) 
  parceldata <- parceldata %>% mutate_if(is.character,as.numeric)
  parcelmeans <- colMeans(parceldata)
  parcelmeans <- as.data.frame(parcelmeans)
  parcelmeans$label <- glasser.parcel.labels$label
  
ggseg(.data = parcelmeans, atlas = "glasser", mapping=aes(fill=parcelmeans), position = c("stacked")) + theme_void() + scale_fill_gradientn(colors = viridis_pal(option="B")(10))
}
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(1)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(2)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(3)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(4)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(5)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(6)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(7)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(8)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(9)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(10)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(11)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(12)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(13)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(14)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(15)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(16)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(17)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(19)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(20)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(21)
```

```{r, warning=F, comment=F, message=F}
alpraz_glasser_averagemap(22)
```

## Catch 22 Feature T-tests

**Conduct paired-samples t-tests and visualize resulting FDR p-values and t-stat brain maps**


```{r}
alpraz_glasser_ttests <- function(feature){
  
  #prepare data for matrixTests
  matname <- sprintf("catch%s_sesxparcel_matrix", feature)
  drug <- eval(as.name(matname)) %>% filter(drug == 0)
  drug <- drug %>% select(-subid, -sesid, -drug, -meanFD)
  drug <- drug %>% mutate_if(is.character,as.numeric)
  placebo <- eval(as.name(matname)) %>% filter(drug == 1)
  placebo <- placebo %>% select(-subid, -sesid, -drug, -meanFD)
  placebo <- placebo %>% mutate_if(is.character,as.numeric)
  
  #run paired t-tests on each parcel (column)
  tstats <- col_t_paired(drug, placebo)
  write.csv(x = tstats, file = sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/t_tests/paired_t_results_catch%s", feature))
  
  #t-statistic histogram
  #hist(tstats$statistic, col = "dodgerblue4", xlab = "paired t-statistic", main = sprintf("Catch22 Feature %s", feature))
  
  print("Number of significant parcels (uncorrected)")
  num <- nrow(as.data.frame(tstats$pvalue) %>% filter(`tstats$pvalue` < 0.05))
  print(num)
  
  #FDR-corrected p-value histogram
  ps.fdr <- p.adjust(na.omit(tstats$pvalue))
  par(mfrow=c(1,2))
  hist(tstats$pvalue, col = "mediumpurple4", xlab = "Paired t-test p-values", main = sprintf("Feature %s", feature))
  hist(ps.fdr, col = "dodgerblue4", xlab = "Paired t-test FDR-corrected p-values", main = sprintf("Feature %s", feature))
  
  #t-stat brain map
  tstatistics <- tstats$statistic
  tstatistics <- as.data.frame(tstatistics)
  tstatistics$label <- glasser.parcel.labels$label
  
  ggseg(.data = tstatistics, atlas = "glasser", mapping=aes(fill=tstatistics), position = c("stacked")) + theme_void() + scale_fill_distiller(palette = "RdBu") 
}
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(1)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(2)
```


```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(3)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(4)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(5)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(6)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(7)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(8)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(9)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(10)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(11)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(12)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(13)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(14)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(15)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(16)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(17)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(18)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(19)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(20)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(21)
```

```{r, warning=F, message=F, comment=F}
alpraz_glasser_ttests(22)
```

## Catch22 PCA

```{r}
alpraz_glasser_PCA_logistic <- function(feature){
  #format and clean input data
  dataname <- sprintf("catch%s_sesxparcel_matrix", feature)
  inputmatrix <- eval(as.name(dataname))
  inputmatrix <- inputmatrix %>% dplyr::select(-subid, -sesid, -drug, -meanFD) 
  inputmatrix <- inputmatrix %>% mutate_if(is.character,as.numeric)
  inputmatrix <- as.data.frame(inputmatrix) #convert matrix to df
  inputmatrix.cleaned <- inputmatrix[, unlist(lapply(inputmatrix, function(x) !all(is.na(x))))] #remove all columns (parcels) with null data (all NAs) #84x232
  
  #PCA
  catch.pca <- prcomp(inputmatrix.cleaned, scale. = TRUE, center = TRUE) 
  saveRDS(catch.pca, file = sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/pca/loadings/%s.pca.loadings.glasser.Rdata", feature))
  
  #How much variance do the first ten components explain?
  print(summary(catch.pca)$importance[2,1:10]*100)
  
  #Scree plot #eblow room eblow room
  #pve <- 100*(catch.pca$sdev)^2/sum ((catch.pca$sdev)^2)

 # plot(pve, pch=16, 
  #   xlab="Principal Components",
   #  ylab="Prop. of variance explained")
  
  #Save each subject's first 10 PCs to a csv
  catch.pca.scores <- as.data.frame(catch.pca$x[,1:10]) #every subject's data (rows) for the first 10 PCs
  catch.pca.scores$subid <- participants$V1 #match subids to scores
  catch.pca.scores$sesid <- participants$V2 #match sesids to scores
  catch.pca.scores$drug <- participants$V3 #add drug v placebo information
  catch.pca.scores$meanFD <- participants$V4 #add motion 
  write.csv(x= catch.pca.scores,
            file = sprintf("/cbica/projects/spatiotemp_dev_plasticity/Inhibition/Alpraz/catch22_glasser360/pca/scores/catch%s.PCA.scores.glasser.csv", feature),
            quote = F, row.names = F)
  
  summary(glm(as.factor(catch.pca.scores$drug) ~ catch.pca.scores$PC1 + catch.pca.scores$meanFD, family=binomial(logit)))
}
```

```{r}
alpraz_glasser_PCA_logistic(1)
```

```{r}
alpraz_glasser_PCA_logistic(2)
```

```{r}
alpraz_glasser_PCA_logistic(4)
```

```{r}
alpraz_glasser_PCA_logistic(5)
```
```{r}
alpraz_glasser_PCA_logistic(6)
```

```{r}
alpraz_glasser_PCA_logistic(7)
```
```{r}
alpraz_glasser_PCA_logistic(8)
```

```{r}
alpraz_glasser_PCA_logistic(9)
```

```{r}
alpraz_glasser_PCA_logistic(10)
```

```{r}
alpraz_glasser_PCA_logistic(11)
```

```{r}
alpraz_glasser_PCA_logistic(12)
```

```{r}
alpraz_glasser_PCA_logistic(13)
```

```{r}
alpraz_glasser_PCA_logistic(14)
```

```{r}
alpraz_glasser_PCA_logistic(15)
```

```{r}
alpraz_glasser_PCA_logistic(16)
```

```{r}
alpraz_glasser_PCA_logistic(17)
```

```{r}
alpraz_glasser_PCA_logistic(18)
```

```{r}
alpraz_glasser_PCA_logistic(19)
```

```{r}
alpraz_glasser_PCA_logistic(20)
```

```{r}
alpraz_glasser_PCA_logistic(21)
```

```{r}
alpraz_glasser_PCA_logistic(22)
```
## Catch22 Ridge Regression


